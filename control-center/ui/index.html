<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ClawForge</title>
  <style>
    body{font-family:system-ui,Segoe UI,Arial;max-width:980px;margin:24px auto;padding:0 16px;background:#0b0f14;color:#e7eef7}
    a{color:#8bd5ff}
    .card{background:#121926;border:1px solid #243247;border-radius:12px;padding:16px;margin:12px 0}
    .row{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
    input,button{font-size:14px;padding:8px 10px;border-radius:10px;border:1px solid #2a3b54;background:#0f1520;color:#e7eef7}
    button{cursor:pointer}
    pre{white-space:pre-wrap;word-break:break-word;background:#0f1520;border:1px solid #243247;border-radius:10px;padding:12px}
    .muted{color:#9bb0c7}
  </style>
</head>
<body>
  <h1>ClawForge (LAN)</h1>
  <div class="muted">Ops + Unreal control center. This is an MVP; we’ll iterate fast.</div>

  <div class="card">
    <div class="row">
      <strong>Nav:</strong>
      <a href="#ops">Ops</a>
      <a href="#unreal">Unreal</a>
      <a href="#approvals">Approvals</a>
      <a href="#jobs">Jobs</a>
    </div>
  </div>

  <div class="card">
    <h2>Login</h2>
    <div class="row">
      <input id="pw" type="password" placeholder="Admin password (printed on first run)" size="40" />
      <button onclick="login()">Login</button>
      <button onclick="logout()">Logout</button>
    </div>
    <div id="loginStatus" class="muted"></div>
  </div>

  <div class="card">
    <h2>Ping</h2>
    <button onclick="ping()">/api/ping</button>
    <pre id="pingOut"></pre>
  </div>

  <div class="card" id="ops">
    <h2>Nodes</h2>
    <div class="row">
      <button onclick="loadNodesLive()">Refresh (live)</button>
      <span class="muted">Auto-refresh: <span id="autoOn">on</span></span>
    </div>
    <pre id="nodesOut"></pre>
  </div>

  <div class="card" id="unreal">
    <h2>Unreal (UE 5.7)</h2>
    <div class="row">
      <input id="projName" placeholder="Project name (e.g. ClawBP57)" size="32" />
      <button onclick="createProj('bp')">Create BP + Launch</button>
      <button onclick="createProj('cpp')">Create C++ + Launch</button>
    </div>
    <div class="muted">Defaults: root D:\\UnrealProjects · templates TP_ThirdPersonBP / TP_ThirdPerson · UE root D:\\UE_5.7</div>
    <pre id="unrealOut"></pre>
  </div>

  <div class="card" id="approvals">
    <h2>Approvals: Device Pairing</h2>
    <div class="row">
      <button onclick="loadPending()">Refresh pending</button>
      <span class="muted">Approve/reject requires login.</span>
    </div>
    <div class="row">
      <span class="muted">Pending:</span>
      <span id="pendingCount" class="muted">0</span>
    </div>
    <div id="pendingTable"></div>
    <pre id="pendingOut" style="display:none"></pre>
  </div>

  <div class="card" id="jobs">
    <h2>Jobs (queue)</h2>
    <button onclick="loadJobs()">Refresh jobs</button>
    <pre id="jobsOut"></pre>
  </div>

  <div class="card">
    <h2>OpenClaw state (devices)</h2>
    <button onclick="loadState()">Load state</button>
    <pre id="stateOut"></pre>
  </div>

<script>
async function j(url, opts={}){
  const res = await fetch(url, {
    headers: { 'Content-Type': 'application/json' },
    credentials: 'include',
    ...opts,
  });
  const txt = await res.text();
  let data;
  try { data = JSON.parse(txt); } catch { data = { raw: txt }; }
  return { ok: res.ok, status: res.status, data };
}

async function ping(){
  const r = await j('/api/ping');
  document.getElementById('pingOut').textContent = JSON.stringify(r, null, 2);
}

async function loadNodes(){
  const r = await j('/api/nodes');
  document.getElementById('nodesOut').textContent = JSON.stringify(r, null, 2);
}

async function loadNodesLive(){
  const r = await j('/api/nodes/live');
  document.getElementById('nodesOut').textContent = JSON.stringify(r, null, 2);
}

// Auto-refresh nodes
setInterval(() => {
  loadNodesLive().catch(() => {});
}, 5000);

async function loadState(){
  const r = await j('/api/openclaw/state');
  document.getElementById('stateOut').textContent = JSON.stringify(r, null, 2);
}

async function loadJobs(){
  const r = await j('/api/jobs');
  document.getElementById('jobsOut').textContent = JSON.stringify(r, null, 2);
}

async function createProj(kind){
  const name = document.getElementById('projName').value.trim();
  const r = await j('/api/unreal/create', { method:'POST', body: JSON.stringify({ name, kind }) });
  document.getElementById('unrealOut').textContent = JSON.stringify(r, null, 2);
  await loadJobs();
}

async function login(){
  const pw = document.getElementById('pw').value;
  const r = await j('/api/login', { method:'POST', body: JSON.stringify({ password: pw }) });
  document.getElementById('loginStatus').textContent = r.ok ? 'Logged in.' : ('Login failed: ' + JSON.stringify(r.data));
}

async function logout(){
  const r = await j('/api/logout', { method:'POST' });
  document.getElementById('loginStatus').textContent = r.ok ? 'Logged out.' : ('Logout error: ' + JSON.stringify(r.data));
}

function esc(s){
  return String(s ?? '').replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;');
}

function renderPending(items){
  const el = document.getElementById('pendingTable');
  document.getElementById('pendingCount').textContent = String(items.length);
  if(!items.length){
    el.innerHTML = '<div class="muted">No pending device pairing requests.</div>';
    return;
  }
  const rows = items.map(it => {
    const rid = esc(it.requestId);
    const name = esc(it.displayName || it.deviceId);
    const ip = esc(it.remoteIp || '');
    const platform = esc(it.platform || '');
    return `
      <div class="card" style="margin:10px 0">
        <div><strong>${name}</strong> <span class="muted">(${platform})</span></div>
        <div class="muted">requestId: ${rid}</div>
        <div class="muted">ip: ${ip}</div>
        <div class="row" style="margin-top:8px">
          <button onclick="approve('${rid}')">Approve</button>
          <button onclick="reject('${rid}')">Reject</button>
        </div>
      </div>
    `;
  }).join('');
  el.innerHTML = rows;
}

async function loadPending(){
  const r = await j('/api/devices/pending');
  if(r.ok && r.data && r.data.items){
    renderPending(r.data.items);
  } else {
    document.getElementById('pendingTable').innerHTML = '<div class="muted">Error loading pending: ' + esc(JSON.stringify(r.data)) + '</div>';
  }
}

async function approve(requestId){
  const r = await j(`/api/devices/${requestId}/approve`, { method:'POST', body: '{}' });
  await loadPending();
  if(!r.ok){ alert('Approve failed: ' + JSON.stringify(r.data)); }
}

async function reject(requestId){
  const r = await j(`/api/devices/${requestId}/reject`, { method:'POST', body: '{}' });
  await loadPending();
  if(!r.ok){ alert('Reject failed: ' + JSON.stringify(r.data)); }
}

// Auto-refresh pending approvals
setInterval(() => {
  loadPending().catch(() => {});
}, 5000);
</script>
</body>
</html>
